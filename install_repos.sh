echo "==================================================================="
echo "BUILDING ZIMBRA P25 LOCAL REPO"
echo "==================================================================="
repoDir="/opt/zimbra_p25_repo"
scriptDir=$(pwd)

rpm --import https://files.zimbra.com/downloads/security/public.key

echo "
[zimbra]
name=Zimbra RPM Repository
baseurl=https://repo.zimbra.com/rpm/87/rhel8
gpgcheck=1
enabled=1

[zimbra-90-oss]
name=Zimbra New RPM Repository
baseurl=https://repo.zimbra.com/rpm/90/rhel8
gpgcheck=1
enabled=1

[zimbra-90-network]
name=Zimbra New RPM Repository
baseurl=https://repo.zimbra.com/rpm/90-ne/rhel8
gpgcheck=1
enabled=1
" > /etc/yum.repos.d/zimbra.repo

dnf repolist
dnf makecache

mkdir $repoDir
dnf download --downloadonly $(cat $scriptDir/p25_deps.txt | xargs) --downloaddir=$repoDir

dnf install createrepo perl -y
createrepo_c $repoDir

echo "
[zimbra_p25_custom]
name=Zimbra p25 Repo
enabled=1
baseurl=file://$repoDir
gpgchecked=0
" > /etc/yum.repos.d/zimbra_p25_custom.repo

dnf config-manager --set-disabled zimbra zimbra-90-oss zimbra-90-network
dnf repolist
dnf makecache

cd $scriptDir
wget https://files.zimbra.com/downloads/9.0.0_GA/zcs-NETWORK-9.0.0_GA_3954.RHEL8_64.20200629045300.tgz
tar -xvf zcs-NETWORK-9.0.0_GA_3954.RHEL8_64.20200629045300.tgz
mv zcs-NETWORK-9.0.0_GA_3954.RHEL8_64.20200629045300 zimbra-installer
echo "Repo ready, now go inside zimbra-installer direcotry to install zimbra with the install.sh script"
