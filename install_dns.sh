echo "==================================================================="
echo "BUILDING DNS SERVER FOR ZIMBRA"
echo "==================================================================="

echo "Available interfaces"
ip a
read -p "System IP to use: " systemIP
read -p "System Base Domian to use: " serverDNS
nmcli connection show
read -p "System connection name to use: " systemCon

dnf install bind-chroot -y
systemctl enable named-chroot
systemctl start named-chroot

echo "\$TTL 86400
@   IN  SOA mail.$serverDNS. admin.$serverDNS. (
                2022040905 ; Serial
                3600       ; Refresh
                1800       ; Retry
                604800     ; Expire
                86400 )    ; Minimum TTL

@ IN  A   $systemIP

      NS  mail.$serverDNS.
      MX  10 mail.$serverDNS.
mail IN A   $systemIP

www IN  CNAME   mail.$serverDNS." > /var/named/$serverDNS.zone

echo "
zone \"$serverDNS\" IN {
	type master;
	file \"$serverDNS.zone\";
};" >> /etc/named.conf

cat /etc/named.conf | sed -E "s/(listen-on port 53.*)/#\1/" \
	| sed -E "s/(listen-on-v6 port 53.*)/#\1/" \
	| sed -E "s/(allow-query.*)/allow-query { any; };/" > /tmp/named.conf.tmp
cat /tmp/named.conf.tmp > /etc/named.conf

systemctl restart named-chroot

hostnamectl set-hostname mail.$serverDNS --static
echo "$systemIP mail.$serverDNS mail" >> /etc/hosts

nmcli conn modify "$systemCon" ipv4.ignore-auto-dns yes
nmcli conn modify "$systemCon" ipv4.dns  "$systemIP 8.8.8.8"
systemctl restart NetworkManager

firewall-cmd --permanent --add-service=dns
firewall-cmd --reload
systemctl restart firewalld
